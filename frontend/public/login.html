<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cute Login Page</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg-top: #14b8a6;
      /* accent teal to match app */
      --bg-bottom: #06b6d4;
      /* accent cyan to match app */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background:
        radial-gradient(ellipse at center, rgba(6, 182, 212, 0.1) 0%, rgba(3, 7, 18, 0.8) 70%),
        radial-gradient(ellipse at center, rgba(20, 184, 166, 0.05) 0%, rgba(3, 7, 18, 0.9) 100%),
        #030712;
      /* app background base */
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      color: #f8fafc;
      position: relative;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      position: relative;
    }

    /* Floating Blockchain Animation */
    .floating-blockchain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .blockchain-cube {
      position: absolute;
      width: 20px;
      height: 20px;
      background: linear-gradient(45deg, #14b8a6, #06b6d4);
      border-radius: 4px;
      opacity: 0.6;
      animation: floatUp 15s linear infinite;
      box-shadow: 0 0 20px rgba(20, 184, 166, 0.3);
    }

    .cube-1 {
      left: 10%;
      animation-delay: 0s;
    }

    .cube-2 {
      left: 20%;
      animation-delay: 2s;
      transform: rotate(45deg);
    }

    .cube-3 {
      left: 80%;
      animation-delay: 4s;
    }

    .cube-4 {
      left: 70%;
      animation-delay: 6s;
      transform: rotate(90deg);
    }

    .cube-5 {
      left: 90%;
      animation-delay: 8s;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }

      10% {
        opacity: 0.6;
      }

      90% {
        opacity: 0.6;
      }

      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* -------- Faces Container -------- */
    .faces-container {
      display: flex;
      align-items: flex-end;
      gap: 15px;
      margin-bottom: 20px;
    }

    .face {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, .25);
      transition: transform .3s ease;
      animation: float 5s ease-in-out infinite;
    }

    .faces-container .face:nth-child(1) {
      animation-delay: 0s;
    }

    .faces-container .face:nth-child(2) {
      animation-delay: .8s;
    }

    .faces-container .face:nth-child(3) {
      animation-delay: 1.6s;
    }

    .faces-container .face:nth-child(4) {
      animation-delay: 2.4s;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-6px);
      }
    }

    /* Shapes */
    .orange {
      width: 120px;
      height: 60px;
      background: linear-gradient(180deg, #FFA359 0%, #FF8730 60%, #E56F17 100%);
      border-radius: 120px 120px 0 0;
    }

    .purple {
      width: 80px;
      height: 140px;
      background: linear-gradient(180deg, #9A78FF 0%, #7B4CFF 60%, #5F30E4 100%);
    }

    .green {
      width: 60px;
      height: 110px;
      background: linear-gradient(180deg, #69D39A 0%, #3CB371 60%, #2C8A56 100%);
      border-radius: 10px;
    }

    .yellow {
      width: 80px;
      height: 120px;
      background: linear-gradient(180deg, #FFE979 0%, #FFD93D 60%, #E0B90A 100%);
      border-radius: 40px;
    }

    /* (glossy head highlight removed) */

    /* (brows removed) */

    /* Eyes */
    .eyes {
      position: absolute;
      display: flex;
      gap: 8px;
    }

    .eye {
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
    }

    .eye::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 5px;
      height: 5px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .95), rgba(255, 255, 255, .2));
      border-radius: 50%;
      pointer-events: none;
    }

    /* subtle glow makes eyes cuter */
    .eye {
      box-shadow: 0 0 8px rgba(255, 255, 255, .6) inset;
    }

    .pupil {
      width: 6px;
      height: 6px;
      background: #000;
      border-radius: 50%;
      position: absolute;
      top: 4px;
      left: 4px;
      transition: all .1s ease-out;
      transform-origin: center;
    }

    .eyelid {
      position: absolute;
      left: 0;
      top: -14px;
      width: 100%;
      height: 14px;
      background: #f2f2f2;
      border-top-left-radius: 50%;
      border-top-right-radius: 50%;
      transform: translateY(0);
      transition: transform .2s ease;
      pointer-events: none;
    }

    /* (blush removed) */

    /* Mouth base */
    .mouth {
      position: absolute;
      width: 30px;
      height: 8px;
      background: #000;
      left: 50%;
      transform: translateX(-50%);
      top: 65%;
      border-radius: 10px;
      transition: all .3s ease;
    }

    /* Expression states */
    .mouth.flat {
      height: 4px;
      border-radius: 0;
    }

    .mouth.smile {
      height: 15px;
      border-radius: 0 0 40px 40px;
      background: none;
      border-bottom: 4px solid #000;
    }

    .mouth.sad {
      height: 15px;
      border-radius: 40px 40px 0 0;
      background: none;
      border-top: 4px solid #000;
    }

    /* Tear for extra realism when sad */
    .tear {
      position: absolute;
      top: 36px;
      left: 50%;
      width: 6px;
      height: 10px;
      background: radial-gradient(circle at 50% 20%, #bfe9ff, #5ec6ff);
      border-radius: 50% 50% 60% 60%;
      opacity: 0;
      transform: translateX(-50%) translateY(-6px);
      transition: opacity .25s ease, transform .35s ease;
      filter: drop-shadow(0 1px 1px rgba(0, 0, 0, .2));
    }

    .tear.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Login card */
    .login-form {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
      width: 350px;
      position: relative;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-form:hover {
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.7),
        0 0 30px rgba(20, 184, 166, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .input-group {
      margin-bottom: 20px;
      position: relative;
    }

    input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color .3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--bg-top);
    }

    .password-wrapper {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 20px;
      color: #666;
      transition: color .3s ease;
    }

    .toggle-password:hover {
      color: var(--bg-top);
    }

    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .error-message {
      color: #e74c3c;
      text-align: center;
      margin-top: 15px;
      opacity: 0;
      transition: opacity .3s ease;
    }

    .error-message.show {
      opacity: 1;
    }

    /* Auth extras */
    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 14px;
    }

    .muted-link {
      color: #4a6ee0;
      text-decoration: none;
      cursor: pointer;
    }

    .muted-link:hover {
      text-decoration: underline;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      color: #888;
      font-size: 12px;
    }

    .divider::before,
    .divider::after {
      content: "";
      height: 1px;
      background: #e0e0e0;
      flex: 1;
    }

    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      color: #333;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .social-btn:hover {
      border-color: #c8c8c8;
    }

    .hidden {
      display: none;
    }

    /* Pulse Animation */
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
        transform: scale(1.1);
      }
    }

    /* Enhanced Focus States */
    input:focus {
      outline: none;
      border-color: var(--bg-top);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #14b8a6, #06b6d4);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #0d9488, #0891b2);
    }

    /* Text Selection */
    ::selection {
      background: rgba(20, 184, 166, 0.3);
      color: #f8fafc;
    }

    /* Enhanced Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(3, 7, 18, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .loading-box {
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      border: 1px solid rgba(20, 184, 166, 0.3);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      backdrop-filter: blur(20px);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(20, 184, 166, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      min-width: 300px;
      animation: slideUp 0.5s ease;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(20, 184, 166, 0.3);
      border-top: 3px solid #14b8a6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-title {
      font-size: 24px;
      font-weight: 700;
      color: #14b8a6;
      margin-bottom: 10px;
      text-shadow: 0 0 10px rgba(20, 184, 166, 0.3);
    }

    .loading-message {
      font-size: 16px;
      color: #f8fafc;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    .loading-progress {
      width: 100%;
      height: 4px;
      background: rgba(20, 184, 166, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 15px;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #14b8a6, #06b6d4);
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
      animation: progressPulse 2s ease-in-out infinite;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes progressPulse {

      0%,
      100% {
        box-shadow: 0 0 5px rgba(20, 184, 166, 0.3);
      }

      50% {
        box-shadow: 0 0 20px rgba(20, 184, 166, 0.6);
      }
    }

    /* Celebration Modal */
    .celebration-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .celebration-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .celebration-content {
      background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      position: relative;
      transform: scale(0.7) translateY(50px);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .celebration-modal.show .celebration-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .celebration-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: bounce 1s ease infinite;
    }

    .celebration-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
    }

    .celebration-message {
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      margin-bottom: 30px;
    }

    .celebration-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .celebration-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    /* Confetti Animation */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #fff;
      animation: confetti-fall 3s ease-in-out forwards;
    }

    .confetti:nth-child(1) {
      left: 10%;
      animation-delay: 0s;
      background: #ff6b6b;
    }

    .confetti:nth-child(2) {
      left: 20%;
      animation-delay: 0.2s;
      background: #4ecdc4;
    }

    .confetti:nth-child(3) {
      left: 30%;
      animation-delay: 0.4s;
      background: #ffe66d;
    }

    .confetti:nth-child(4) {
      left: 40%;
      animation-delay: 0.6s;
      background: #ff8b94;
    }

    .confetti:nth-child(5) {
      left: 50%;
      animation-delay: 0.8s;
      background: #a8e6cf;
    }

    .confetti:nth-child(6) {
      left: 60%;
      animation-delay: 1s;
      background: #dcedc8;
    }

    .confetti:nth-child(7) {
      left: 70%;
      animation-delay: 1.2s;
      background: #ffd3a5;
    }

    .confetti:nth-child(8) {
      left: 80%;
      animation-delay: 1.4s;
      background: #a8e6cf;
    }

    .confetti:nth-child(9) {
      left: 90%;
      animation-delay: 1.6s;
      background: #ffaaa5;
    }

    .confetti:nth-child(10) {
      left: 95%;
      animation-delay: 1.8s;
      background: #ffe66d;
    }

    .confetti:nth-child(11) {
      left: 15%;
      animation-delay: 0.3s;
      background: #ff9ff3;
    }

    .confetti:nth-child(12) {
      left: 35%;
      animation-delay: 0.7s;
      background: #54a0ff;
    }

    .confetti:nth-child(13) {
      left: 55%;
      animation-delay: 1.1s;
      background: #5f27cd;
    }

    .confetti:nth-child(14) {
      left: 75%;
      animation-delay: 1.5s;
      background: #00d2d3;
    }

    .confetti:nth-child(15) {
      left: 85%;
      animation-delay: 1.9s;
      background: #ff9f43;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      70% {
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    @keyframes bounce {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }
  </style>
</head>

<body>
  <!-- Enhanced Loading Indicator -->
  <div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-box">
      <div class="loading-spinner"></div>
      <div class="loading-title">DecentraTask</div>
      <div class="loading-message" id="loadingText">Signing in...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
  <style>
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>

  <!-- OTP Modal -->
  <div class="celebration-modal" id="otpModal">
    <div class="celebration-content" style="max-width: 450px;">
      <div class="celebration-icon" style="font-size: 50px;">🔐</div>
      <div class="celebration-title">Enter Reset Code</div>
      <div class="celebration-message" id="otpMessage">We've sent a 6-digit code to your email. Enter it below to reset your password.</div>
      
      <div style="margin: 25px 0;">
        <input type="text" id="otpInput" placeholder="Enter 6-digit code" maxlength="6" 
               style="width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; 
                      font-size: 18px; text-align: center; letter-spacing: 4px; background: rgba(255,255,255,0.1); 
                      color: white; font-weight: bold; margin-bottom: 15px;">
        <input type="password" id="newPasswordInput" placeholder="New Password" 
               style="width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; 
                      font-size: 16px; background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
        <input type="password" id="confirmPasswordInput" placeholder="Confirm New Password" 
               style="width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; 
                      font-size: 16px; background: rgba(255,255,255,0.1); color: white;">
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="celebration-btn" id="verifyOTPBtn" style="flex: 1;">Reset Password</button>
        <button class="celebration-btn" id="resendOTPBtn" style="flex: 1; background: rgba(255,255,255,0.1);">Resend Code</button>
      </div>
      
      <button class="celebration-btn" id="cancelOTPBtn" style="background: rgba(255,255,255,0.1);">Cancel</button>
      
      <div id="otpError" style="color: #ff6b6b; margin-top: 15px; font-size: 14px; display: none;"></div>
      <div id="otpTimer" style="color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 12px;"></div>
    </div>
  </div>

  <!-- Celebration Modal -->
  <div class="celebration-modal" id="celebrationModal">
    <div class="celebration-content">
      <div class="celebration-icon" id="celebrationIcon">🎉</div>
      <div class="celebration-title" id="celebrationTitle">Welcome Back!</div>
      <div class="celebration-message" id="celebrationMessage">Login successful! Redirecting you now...</div>
      <button class="celebration-btn" onclick="closeCelebrationNoRedirect()">Continue</button>
    </div>
    <!-- Confetti pieces -->
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
    <div class="confetti"></div>
  </div>

  <div class="floating-blockchain">
    <div class="blockchain-cube cube-1"></div>
    <div class="blockchain-cube cube-2"></div>
    <div class="blockchain-cube cube-3"></div>
    <div class="blockchain-cube cube-4"></div>
    <div class="blockchain-cube cube-5"></div>
  </div>

  <div class="container">
    <div class="faces-container">
      <div class="face orange pulse-animation">
        <div class="eyes" style="top:20px;">
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
        </div>
        <div class="tear"></div>
        <div class="mouth flat"></div>
      </div>
      <div class="face purple">
        <div class="eyes" style="top:20px;">
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
        </div>
        <div class="tear"></div>
        <div class="mouth flat"></div>
      </div>
      <div class="face green">
        <div class="eyes" style="top:20px;">
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
        </div>
        <div class="tear"></div>
        <div class="mouth flat"></div>
      </div>
      <div class="face yellow">
        <div class="eyes" style="top:25px;">
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
          <div class="eye">
            <div class="eyelid"></div>
            <div class="pupil"></div>
          </div>
        </div>
        <div class="tear"></div>
        <div class="mouth flat"></div>
      </div>
    </div>

    <div class="login-form" id="loginBox">
      <h2 id="formTitle">Welcome Back!</h2>
      <!-- Login Form -->
      <form id="loginForm">
        <div class="input-group">
          <input type="email" id="email" placeholder="Email" required>
        </div>
        <div class="input-group">
          <div class="password-wrapper">
            <input type="password" id="password" placeholder="Password" required>
            <span class="toggle-password" id="togglePassword">👁️</span>
          </div>
        </div>
        <div class="actions-row">
          <span class="muted-link" id="forgotPasswordLink">Forgot password?</span>
          <span class="muted-link" id="toSignup">Create account</span>
        </div>
        <button type="submit" id="loginBtn">Login</button>
        <div class="divider">or</div>
        <button type="button" class="social-btn" id="googleBtn">🔵 Continue with Google</button>
        <div class="error-message" id="errorMessage"></div>
      </form>

      <!-- Signup Form -->
      <form id="signupForm" class="hidden">
        <div class="input-group">
          <input type="text" id="signupUsername" placeholder="Username" required>
        </div>
        <div class="input-group">
          <input type="email" id="signupEmail" placeholder="Email" required>
        </div>
        <div class="input-group">
          <div class="password-wrapper">
            <input type="password" id="signupPassword" placeholder="Password" required>
            <span class="toggle-password" id="togglePasswordSignup">👁️</span>
          </div>
        </div>
        <div class="input-group">
          <select id="userType" required
            style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white;">
            <option value="">Select Account Type</option>
            <option value="client">Client (Post Tasks)</option>
            <option value="freelancer">Freelancer (Find Tasks)</option>
          </select>
        </div>
        <div class="actions-row">
          <span></span>
          <span class="muted-link" id="toLogin">Have an account? Sign in</span>
        </div>
        <button type="submit" id="signupBtn">Sign Up</button>
        <div class="divider">or</div>
        <button type="button" class="social-btn" id="googleBtnSignup">🔵 Continue with Google</button>
        <div class="error-message" id="signupErrorMessage"></div>
      </form>
    </div>
  </div>

  <!-- Clear auth state first -->
  <script src="clear-auth.js"></script>

  <!-- Configuration -->
  <script src="config.js" onerror="console.warn('config.js not found, using fallback configuration')"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <script>
    // Environment guard: Firebase Auth requires http/https/chrome-extension protocols
    (function ensureSupportedProtocol() {
      var proto = (window && window.location && window.location.protocol) || '';
      if (proto !== 'http:' && proto !== 'https:' && proto !== 'chrome-extension:') {
        alert('This page must be served over http/https (or a Chrome extension).\nOpen it via a local dev server, not from a file:// URL.');
      }
    })();

    // Firebase config loading with safe fallbacks
    // Priority: APP_CONFIG -> localStorage('firebaseConfig') -> fallback config
    function loadFirebaseConfig() {
      // 1) From APP_CONFIG if provided
      if (window && window.APP_CONFIG && window.APP_CONFIG.FIREBASE_CONFIG && window.APP_CONFIG.FIREBASE_CONFIG.apiKey) {
        return window.APP_CONFIG.FIREBASE_CONFIG;
      }
      // 2) From localStorage
      try {
        const saved = localStorage.getItem('firebaseConfig');
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.apiKey) return parsed;
        }
      } catch (e) { }
      // 3) Prompt user to paste their config
      try {
        const maybe = prompt('Firebase config not found. Paste your Firebase config JSON (from Console > Project settings):');
        if (maybe) {
          const parsed = JSON.parse(maybe);
          if (parsed && parsed.apiKey) {
            localStorage.setItem('firebaseConfig', JSON.stringify(parsed));
            return parsed;
          }
        }
      } catch (e) { }
      console.error('Firebase configuration not found. Please check your config.js file or provide configuration.');
      // Return a fallback config to prevent page from breaking
      return {
        apiKey: "demo-key",
        authDomain: "demo.firebaseapp.com",
        projectId: "demo-project"
      };
    }

    // Celebration Modal Functions
    function showCelebration(title, message, icon = "🎉") {
      const modal = document.getElementById('celebrationModal');
      const titleEl = document.getElementById('celebrationTitle');
      const messageEl = document.getElementById('celebrationMessage');
      const iconEl = document.getElementById('celebrationIcon');

      titleEl.textContent = title;
      messageEl.textContent = message;
      iconEl.textContent = icon;

      modal.classList.add('show');

      // Add some celebration sound effect (optional - browser will play if supported)
      try {
        // Create a simple celebration sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // Ignore audio errors - not critical
      }

      // Auto close after 2 seconds (no redirect by default)
      setTimeout(() => {
        closeCelebrationNoRedirect();
      }, 2000);
    }

    function closeCelebration(shouldRedirect = true) {
      const modal = document.getElementById('celebrationModal');
      modal.classList.remove('show');
      // Only redirect if specified (for login success, not password reset)
      if (shouldRedirect) {
        window.location.href = '/';
      }
    }

    function closeCelebrationNoRedirect() {
      closeCelebration(false);
    }
    
    function showCelebrationAndRedirect(title, message, icon = "🎉") {
      showCelebration(title, message, icon);
      // Override the auto-close to redirect
      setTimeout(() => {
        closeCelebration(true); // This will redirect
      }, 2000);
    }
    
    function clearAllAuthData() {
      // Clear all possible auth tokens and data
      localStorage.removeItem('access_token');
      localStorage.removeItem('firebase_token');
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_data');
      localStorage.removeItem('user_id');
      localStorage.removeItem('user_email');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_type');
      localStorage.removeItem('firebase_user');
      localStorage.removeItem('is_authenticated');
      localStorage.removeItem('auth_method');
      localStorage.removeItem('show_welcome_celebration');
      console.log('All auth data cleared');
    }

    let firebaseConfig, auth, db;

    // Optimized initialization - faster startup
    try {
      firebaseConfig = loadFirebaseConfig();
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();

      // Preload auth state for faster subsequent operations
      auth.onAuthStateChanged(() => { }, () => { });

    } catch (e) {
      console.error('Firebase initialization failed:', e);
      auth = null;
      db = null;
    }

    // Initialize the app after DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
    });

    // If DOM is already ready, initialize immediately
    if (document.readyState === 'loading') {
      // DOM is still loading, wait for DOMContentLoaded
    } else {
      // DOM is already ready
      initializeApp();
    }

    async function initializeApp() {
      console.log('Initializing app...');

      // Clean up any old redirect states since we're using popup now
      localStorage.removeItem('auth_redirect_state');

      // Check if user is already authenticated - BUT ONLY FOR FIREBASE USERS
      auth.onAuthStateChanged(async (user) => {
        console.log('Auth state changed. User:', user ? user.uid : 'null');

        // Check if we have custom auth tokens first
        const customToken = localStorage.getItem('access_token');
        const authMethod = localStorage.getItem('auth_method');
        
        if (customToken && authMethod === 'custom') {
          console.log('Custom auth detected, ignoring Firebase auth state');
          return; // Don't redirect if we have custom auth
        }

        if (user) {
          console.log('Firebase user authenticated:', user.uid, user.email);

          try {
            // Get and store the Firebase token for the main app to use
            const idToken = await user.getIdToken(false);
            localStorage.setItem('firebase_token', idToken);
            localStorage.setItem('auth_method', 'firebase');
            console.log('Firebase token stored for main app');

            // User is already signed in with Firebase, redirect to main app
            console.log('Firebase user already signed in, redirecting to main app...');
            window.location.href = '/';
          } catch (error) {
            console.error('Error getting token for existing user:', error);
            window.location.href = '/';
          }
        } else {
          console.log('No Firebase authenticated user found');
        }
      });

      // Remove loading indicators
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }
    }

    // Auth persistence with fallbacks when web storage is blocked/unavailable
    (async function setPersistenceWithFallback() {
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      } catch (e1) {
        try {
          await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
        } catch (e2) {
          try {
            await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
          } catch (e3) {
            // ignore; environment may not support persistence at all
          }
        }
      }
    })();

    // Helpers
    function setBusy(el, busy) {
      if (!el) return;
      el.disabled = !!busy;
      el.style.opacity = busy ? '0.7' : '1';
    }

    async function ensureUserDoc(user, source) {
      if (!user || !user.uid) return;
      const userRef = db.collection('users').doc(user.uid);
      const snap = await userRef.get();
      const base = {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        providerIds: (user.providerData || []).map(p => p && p.providerId).filter(Boolean),
        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      if (snap.exists) {
        await userRef.update(base);
      } else {
        await userRef.set({
          ...base,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          onboardingComplete: false,
          source: source || 'unknown',
        });
      }
    }

    // Handle redirect result for Google sign-in
    if (auth) {
      auth.getRedirectResult().then(async (result) => {
        if (result.credential) {
          // User signed in via redirect
          try {
            await ensureUserDoc(result.user, 'google_redirect');
            alert('Signed in with Google!');
          } catch (e) {
            console.error('Error handling redirect result:', e);
          }
        }
      }).catch((error) => {
        console.error('Redirect result error:', error);
        const errorCode = error.code;
        const errorMessage = error.message;

        // Show error message based on current form
        const msg = errorMessage || 'Google sign-in failed';
        if (!signupForm.classList.contains('hidden')) {
          signupErrorMessage.textContent = msg;
          signupErrorMessage.classList.add('show');
          setTimeout(() => signupErrorMessage.classList.remove('show'), 3000);
        } else {
          errorMessage.textContent = msg;
          errorMessage.classList.add('show');
          setTimeout(() => errorMessage.classList.remove('show'), 3000);
        }
      });
    }

    // Optional: react to auth state (hook for redirect)
    if (auth) {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          try { await ensureUserDoc(user, 'auth_state'); } catch (e) { }
          // You can redirect after login if desired:
          // window.location.href = '/';
        }
      });
    }

    const pupils = document.querySelectorAll('.pupil');
    const mouths = document.querySelectorAll('.mouth');
    const eyelids = document.querySelectorAll('.eyelid');
    const tears = document.querySelectorAll('.tear');
    const loginBox = document.getElementById('loginBox');
    const errorMessage = document.getElementById('errorMessage');
    const signupErrorMessage = document.getElementById('signupErrorMessage');
    const passwordInput = document.getElementById('password');
    const togglePassword = document.getElementById('togglePassword');
    const signupPasswordInput = document.getElementById('signupPassword');
    const togglePasswordSignup = document.getElementById('togglePasswordSignup');

    const emailInput = document.getElementById('email');
    const signupEmailInput = document.getElementById('signupEmail');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const formTitle = document.getElementById('formTitle');
    const toSignup = document.getElementById('toSignup');
    const toLogin = document.getElementById('toLogin');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const googleBtn = document.getElementById('googleBtn');
    const googleBtnSignup = document.getElementById('googleBtnSignup');

    // default gaze slightly upwards
    function setGazeUp() {
      pupils.forEach((p) => {
        p.style.transform = 'translate(1.5px, -3px)';
      });
    }
    setGazeUp();

    let forceGazeUp = passwordInput.type === 'text';

    // toggle password visibility
    togglePassword.addEventListener('click', () => {
      const showing = passwordInput.type === 'text';
      passwordInput.type = showing ? 'password' : 'text';
      togglePassword.textContent = showing ? '👁️' : '🙈';
      forceGazeUp = passwordInput.type === 'text';
      setGazeUp();
    });

    togglePasswordSignup.addEventListener('click', () => {
      const showing = signupPasswordInput.type === 'text';
      signupPasswordInput.type = showing ? 'password' : 'text';
      togglePasswordSignup.textContent = showing ? '👁️' : '🙈';
      forceGazeUp = signupPasswordInput.type === 'text';
      setGazeUp();
    });

    // Eye tracking
    document.addEventListener('mousemove', (e) => {
      const mouseX = e.clientX;
      const mouseY = e.clientY;
      if (forceGazeUp) {
        setGazeUp();
      } else {
        pupils.forEach((pupil) => {
          const eye = pupil.parentElement;
          const rect = eye.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const angle = Math.atan2(mouseY - cy, mouseX - cx);
          const dist = Math.min(4, Math.hypot(mouseX - cx, mouseY - cy) / 25);
          pupil.style.transform = `translate(${Math.cos(angle) * dist}px, ${Math.sin(angle) * dist}px)`;
        });
      }

      // Expression logic
      const loginRect = loginBox.getBoundingClientRect();
      // virtual close hotspot at top-right region of the viewport
      const hotspot = {
        left: window.innerWidth - 160,
        right: window.innerWidth,
        top: 0,
        bottom: 160
      };

      let nearLogin = (
        mouseX > loginRect.left - 100 &&
        mouseX < loginRect.right + 100 &&
        mouseY > loginRect.top - 100 &&
        mouseY < loginRect.bottom + 100
      );

      let nearClose = (
        mouseX > hotspot.left &&
        mouseX < hotspot.right &&
        mouseY > hotspot.top &&
        mouseY < hotspot.bottom
      );

      mouths.forEach((mouth, idx) => {
        mouth.classList.remove('flat', 'smile', 'sad');
        if (nearClose) {
          mouth.classList.add('sad');
        } else if (nearLogin) {
          mouth.classList.add('smile');
        } else {
          mouth.classList.add('flat');
        }
      });

      // eyelids dynamics

      eyelids.forEach((lid) => {
        if (nearClose) {
          lid.style.transform = 'translateY(10px)'; // half close in fear/sad
        } else if (nearLogin) {
          lid.style.transform = 'translateY(0)'; // open
        } else {
          lid.style.transform = 'translateY(4px)'; // relaxed
        }
      });

      // (blush removed)

      tears.forEach((tear) => {
        if (nearClose) {
          tear.classList.add('show');
        } else {
          tear.classList.remove('show');
        }
      });
    });

    // Switch forms
    toSignup.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      formTitle.textContent = 'Create Account';
      errorMessage.textContent = '';
      signupErrorMessage.textContent = '';
    });
    toLogin.addEventListener('click', () => {
      signupForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      formTitle.textContent = 'Welcome Back!';
      errorMessage.textContent = '';
      signupErrorMessage.textContent = '';
    });

    // Forgot password with OTP
    forgotPasswordLink.addEventListener('click', async () => {
      const email = emailInput.value || prompt('Enter your email to reset password:');
      if (!email) return;

      // Validate email format
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errorMessage.textContent = 'Please enter a valid email address';
        errorMessage.classList.add('show');
        setTimeout(() => errorMessage.classList.remove('show'), 3000);
        return;
      }

      try {
        // Show loading state
        forgotPasswordLink.textContent = 'Sending...';
        forgotPasswordLink.style.pointerEvents = 'none';

        // Send forgot password request to our backend
        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        const response = await fetch(`${backendUrl}/api/auth/forgot-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: email })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.detail || 'Failed to send reset code');
        }

        // Show OTP modal
        showOTPModal(email, data.otp); // data.otp will only be present in development mode
        
      } catch (err) {
        errorMessage.textContent = err.message || 'Failed to send reset code';
        errorMessage.classList.add('show');
        setTimeout(() => errorMessage.classList.remove('show'), 3000);
      } finally {
        // Reset button state
        forgotPasswordLink.textContent = 'Forgot password?';
        forgotPasswordLink.style.pointerEvents = 'auto';
      }
    });

    // Email/password login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.textContent = '';
      const email = (emailInput.value || '').trim();
      const pass = passwordInput.value || '';
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errorMessage.textContent = 'Enter a valid email address';
        errorMessage.classList.add('show');
        setTimeout(() => errorMessage.classList.remove('show'), 2500);
        return;
      }
      if (pass.length < 6) {
        errorMessage.textContent = 'Password must be at least 6 characters';
        errorMessage.classList.add('show');
        setTimeout(() => errorMessage.classList.remove('show'), 2500);
        return;
      }
      setBusy(document.getElementById('loginBtn'), true);
      try {
        // Try custom auth first (for password reset users)
        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        
        try {
          const response = await fetch(`${backendUrl}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: email,
              password: pass
            })
          });

          if (response.ok) {
            const data = await response.json();
            
            // Store tokens in multiple formats for compatibility
            localStorage.setItem('access_token', data.access_token);
            localStorage.setItem('firebase_token', data.access_token); // Main app might look for this
            localStorage.setItem('auth_token', data.access_token); // Alternative name
            
            // Store user info for the main app
            if (data.user) {
              localStorage.setItem('user_data', JSON.stringify(data.user));
              localStorage.setItem('user_id', data.user.id);
              localStorage.setItem('user_email', data.user.email);
              localStorage.setItem('user_name', data.user.username || data.user.email.split('@')[0]);
              localStorage.setItem('user_type', data.user.user_type || 'freelancer');
            }
            
            // Create a fake Firebase user object for compatibility
            const fakeFirebaseUser = {
              uid: data.user.id,
              email: data.user.email,
              displayName: data.user.username || 'Srujan Reddy',
              emailVerified: true
            };
            localStorage.setItem('firebase_user', JSON.stringify(fakeFirebaseUser));
            
            // Set authentication flags
            localStorage.setItem('is_authenticated', 'true');
            localStorage.setItem('auth_method', 'custom');
            localStorage.setItem('show_welcome_celebration', 'true');
            
            // CRITICAL: Sign out from Firebase to prevent conflicts
            if (auth && auth.currentUser) {
              try {
                await auth.signOut();
                console.log('Signed out from Firebase to prevent conflicts');
              } catch (error) {
                console.log('Firebase signout error (ignored):', error);
              }
            }
            
            console.log('Custom auth login successful:', data);
            console.log('Stored tokens and user data for main app');
            
            // Redirect to main app (home page)
            window.location.href = '/';
            return;
          } else if (response.status === 401) {
            // Custom auth failed with wrong credentials - don't try Firebase
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Invalid email or password');
          }
        } catch (customAuthError) {
          console.log('Custom auth failed:', customAuthError);
          
          // If it's an authentication error, don't try Firebase fallback
          if (customAuthError.message && 
              (customAuthError.message.includes('Invalid email or password') || 
               customAuthError.message.includes('401'))) {
            throw customAuthError;
          }
        }

        // Fallback to Firebase auth if custom auth fails
        if (!auth) {
          throw new Error('Authentication service not available');
        }

        // Sign in with Firebase
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        const user = userCredential.user;

        // Get Firebase ID token
        const idToken = await user.getIdToken();

        // Verify with backend
        const response = await fetch(`${backendUrl}/api/auth/firebase/verify`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Server error: ${response.status}`);
        }

        const data = await response.json();

        // Store the Firebase ID token for future requests
        localStorage.setItem('firebase_token', idToken);

        // Set flag for welcome celebration in main app
        localStorage.setItem('show_welcome_celebration', 'true');

        // Redirect immediately without showing celebration here
        window.location.href = '/';
      } catch (err) {
        let errorMsg = 'Login failed';
        if (err.code === 'auth/user-not-found') {
          errorMsg = 'No account found with this email';
        } else if (err.code === 'auth/wrong-password') {
          errorMsg = 'Incorrect password';
        } else if (err.code === 'auth/invalid-email') {
          errorMsg = 'Invalid email address';
        } else if (err.code === 'auth/user-disabled') {
          errorMsg = 'This account has been disabled';
        } else if (err.message) {
          errorMsg = err.message;
        }

        errorMessage.textContent = errorMsg;
        errorMessage.classList.add('show');

        // Show sad faces on error
        mouths.forEach(mouth => {
          mouth.classList.remove('flat', 'smile', 'sad');
          mouth.classList.add('sad');
        });
        tears.forEach(tear => tear.classList.add('show'));

        setTimeout(() => {
          errorMessage.classList.remove('show');
          mouths.forEach(mouth => {
            mouth.classList.remove('sad');
            mouth.classList.add('flat');
          });
          tears.forEach(tear => tear.classList.remove('show'));
        }, 3000);
      } finally {
        setBusy(document.getElementById('loginBtn'), false);
      }
    });

    // Email/password signup
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupErrorMessage.textContent = '';
      const username = (document.getElementById('signupUsername').value || '').trim();
      const email = (signupEmailInput.value || '').trim();
      const pass = signupPasswordInput.value || '';
      const userType = document.getElementById('userType').value;

      if (!username) {
        signupErrorMessage.textContent = 'Username is required';
        signupErrorMessage.classList.add('show');
        setTimeout(() => signupErrorMessage.classList.remove('show'), 2500);
        return;
      }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        signupErrorMessage.textContent = 'Enter a valid email address';
        signupErrorMessage.classList.add('show');
        setTimeout(() => signupErrorMessage.classList.remove('show'), 2500);
        return;
      }
      if (pass.length < 6) {
        signupErrorMessage.textContent = 'Password must be at least 6 characters';
        signupErrorMessage.classList.add('show');
        setTimeout(() => signupErrorMessage.classList.remove('show'), 2500);
        return;
      }
      if (!userType) {
        signupErrorMessage.textContent = 'Please select an account type';
        signupErrorMessage.classList.add('show');
        setTimeout(() => signupErrorMessage.classList.remove('show'), 2500);
        return;
      }

      setBusy(document.getElementById('signupBtn'), true);
      try {
        if (!auth) {
          throw new Error('Authentication service not available');
        }

        // Create Firebase user
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        const user = userCredential.user;

        // Update Firebase user profile with username
        await user.updateProfile({
          displayName: username
        });

        // Get Firebase ID token
        const idToken = await user.getIdToken();

        // Create user in backend with user type
        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        const response = await fetch(`${backendUrl}/api/auth/firebase/signup`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            user_type: userType
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          // If backend fails, we should delete the Firebase user to keep things consistent
          await user.delete();
          throw new Error(errorData.detail || `Server error: ${response.status}`);
        }

        const data = await response.json();

        // Store the Firebase ID token for future requests
        localStorage.setItem('firebase_token', idToken);

        // Set flag for welcome celebration in main app
        localStorage.setItem('show_welcome_celebration', 'true');

        // Redirect immediately without showing celebration here
        window.location.href = '/';
      } catch (err) {
        let errorMsg = 'Signup failed';
        if (err.code === 'auth/email-already-in-use') {
          errorMsg = 'An account with this email already exists';
        } else if (err.code === 'auth/invalid-email') {
          errorMsg = 'Invalid email address';
        } else if (err.code === 'auth/weak-password') {
          errorMsg = 'Password is too weak';
        } else if (err.code === 'auth/operation-not-allowed') {
          errorMsg = 'Email/password accounts are not enabled';
        } else if (err.message) {
          errorMsg = err.message;
        }

        signupErrorMessage.textContent = errorMsg;
        signupErrorMessage.classList.add('show');

        // Show sad faces on error
        mouths.forEach(mouth => {
          mouth.classList.remove('flat', 'smile', 'sad');
          mouth.classList.add('sad');
        });
        tears.forEach(tear => tear.classList.add('show'));

        setTimeout(() => {
          signupErrorMessage.classList.remove('show');
          mouths.forEach(mouth => {
            mouth.classList.remove('sad');
            mouth.classList.add('flat');
          });
          tears.forEach(tear => tear.classList.remove('show'));
        }, 3000);
      } finally {
        setBusy(document.getElementById('signupBtn'), false);
      }
    });

    // Fast Google sign-in with redirect (properly handled)
    async function googleSignIn() {
      const loadingEl = document.getElementById('loading');
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');

      try {
        // Show enhanced loading immediately
        loadingEl.style.display = 'flex';
        loadingText.textContent = 'Initializing...';
        progressBar.style.width = '10%';

        // Show loading state on faces
        mouths.forEach(mouth => {
          mouth.classList.remove('flat', 'smile', 'sad');
          mouth.classList.add('smile');
        });

        if (!auth) {
          throw new Error('Authentication service not available');
        }

        // Check if user is already signed in (fastest path)
        const currentUser = auth.currentUser;
        if (currentUser) {
          try {
            loadingText.textContent = 'Using existing session...';
            progressBar.style.width = '50%';

            const idToken = await currentUser.getIdToken(false); // Use cached token
            await verifyWithBackend(idToken, loadingText, progressBar, loadingEl);
            return;
          } catch (error) {
            console.log('Existing session failed, proceeding with new sign-in:', error);
            // Continue with new sign-in if existing session fails
          }
        }



        // Optimize provider setup for speed
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        // Use optimized sign-in flow
        provider.setCustomParameters({
          prompt: 'select_account',
          include_granted_scopes: 'true'
        });

        loadingText.textContent = 'Opening Google Sign-in...';
        progressBar.style.width = '30%';

        // Use signInWithPopup for local development (works better with localhost)
        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        loadingText.textContent = 'Authentication successful...';
        progressBar.style.width = '60%';

        // Get Firebase ID token (force refresh for new sign-in)
        const idToken = await user.getIdToken(true);

        await verifyWithBackend(idToken, loadingText, progressBar, loadingEl);

      } catch (err) {
        console.error('Google sign-in error:', err);
        handleSignInError(err, loadingEl, loadingText);
      }
    }



    // Separate function for backend verification
    async function verifyWithBackend(idToken, loadingText, progressBar, loadingEl) {
      console.log('verifyWithBackend called with token:', idToken ? idToken.substring(0, 20) + '...' : 'null');

      try {
        if (loadingText) loadingText.textContent = 'Verifying credentials...';
        if (progressBar) progressBar.style.width = '70%';

        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        console.log('Backend URL:', backendUrl);

        // Use faster fetch with optimized timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // Reduced to 3 seconds with backend caching

        console.log('Sending request to backend...');
        const response = await fetch(`${backendUrl}/api/auth/firebase/verify`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        console.log('Backend response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Backend error:', errorData);
          throw new Error(errorData.detail || `Server error: ${response.status}`);
        }

        const data = await response.json();
        console.log('Backend verification successful:', data);

        // Store the Firebase ID token for future requests
        localStorage.setItem('firebase_token', idToken);

        if (loadingText) loadingText.textContent = 'Success! Redirecting...';
        if (progressBar) progressBar.style.width = '100%';

        // Hide loading faster
        setTimeout(() => {
          if (loadingEl) loadingEl.style.display = 'none';
        }, 300);

        console.log('Authentication successful, redirecting...');
        // Set flag for welcome celebration in main app
        localStorage.setItem('show_welcome_celebration', 'true');

        // Redirect immediately without showing celebration here
        window.location.href = '/';

      } catch (err) {
        throw err; // Re-throw to be handled by caller
      }
    }



    // Centralized error handling
    function handleSignInError(err, loadingEl, loadingText) {
      // Hide loading
      if (loadingEl) {
        loadingEl.style.display = 'none';
      }

      const code = err && err.code ? String(err.code) : '';
      let errorMessage = err && err.message ? err.message : 'Google sign-in failed';

      // Handle specific error cases for redirect-based auth
      if (code === 'auth/cancelled-popup-request') {
        errorMessage = 'Sign in was cancelled. Please try again.';
      } else if (code === 'auth/network-request-failed') {
        errorMessage = 'Network error. Please check your connection and try again.';
      } else if (code === 'auth/redirect-cancelled-by-user') {
        errorMessage = 'Sign in was cancelled. Please try again.';
      } else if (code === 'auth/redirect-operation-pending') {
        errorMessage = 'Another sign-in is in progress. Please wait.';
      } else if (err.name === 'AbortError') {
        errorMessage = 'Sign in timed out. Please try again.';
      } else if (code === 'auth/no-auth-event') {
        // This is normal for redirect, don't show as error
        return;
      }

      showErrorMessage(errorMessage);

      // Show sad faces on error
      mouths.forEach(mouth => {
        mouth.classList.remove('flat', 'smile', 'sad');
        mouth.classList.add('sad');
      });
      tears.forEach(tear => tear.classList.add('show'));

      setTimeout(() => {
        mouths.forEach(mouth => {
          mouth.classList.remove('sad');
          mouth.classList.add('flat');
        });
        tears.forEach(tear => tear.classList.remove('show'));
      }, 3000);
    }



    // Helper function to show error messages
    function showErrorMessage(msg) {
      if (!signupForm.classList.contains('hidden')) {
        signupErrorMessage.textContent = msg;
        signupErrorMessage.classList.add('show');
        setTimeout(() => signupErrorMessage.classList.remove('show'), 3000);
      } else {
        errorMessage.textContent = msg;
        errorMessage.classList.add('show');
        setTimeout(() => errorMessage.classList.remove('show'), 3000);
      }
    }



    // Only clear auth state if explicitly requested (e.g., after logout)
    window.addEventListener('load', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const shouldClear = urlParams.has('clear_auth') ||
        localStorage.getItem('force_clear_auth') === 'true';

      if (shouldClear) {
        try {
          // Sign out any existing Firebase user
          await auth.signOut();
          // Clear all tokens
          localStorage.removeItem('firebase_token');
          localStorage.removeItem('access_token');
          localStorage.removeItem('cached_user_data');
          localStorage.removeItem('user_cache_time');
          localStorage.removeItem('force_clear_auth');
          console.log('Cleared authentication state');
        } catch (e) {
          console.log('No existing auth state to clear');
        }
        console.log('Preserving existing authentication state');
      }
    });

    // OTP Modal Functions
    let otpEmail = '';
    let otpTimer = null;
    let otpTimeLeft = 600; // 10 minutes in seconds

    function showOTPModal(email, devOTP = null) {
      otpEmail = email;
      const modal = document.getElementById('otpModal');
      const messageEl = document.getElementById('otpMessage');
      const timerEl = document.getElementById('otpTimer');
      const errorEl = document.getElementById('otpError');
      
      // Clear previous state
      document.getElementById('otpInput').value = '';
      document.getElementById('newPasswordInput').value = '';
      document.getElementById('confirmPasswordInput').value = '';
      errorEl.style.display = 'none';
      
      // Set message
      let message = `We've sent a 6-digit code to ${email}. Enter it below to reset your password.`;
      if (devOTP) {
        message += ` (Development mode: ${devOTP})`;
      }
      messageEl.textContent = message;
      
      // Show modal
      modal.classList.add('show');
      
      // Start timer
      startOTPTimer();
      
      // Focus on OTP input
      setTimeout(() => {
        document.getElementById('otpInput').focus();
      }, 300);
    }

    function hideOTPModal() {
      const modal = document.getElementById('otpModal');
      modal.classList.remove('show');
      if (otpTimer) {
        clearInterval(otpTimer);
        otpTimer = null;
      }
    }

    function startOTPTimer() {
      otpTimeLeft = 600; // Reset to 10 minutes
      const timerEl = document.getElementById('otpTimer');
      
      if (otpTimer) {
        clearInterval(otpTimer);
      }
      
      otpTimer = setInterval(() => {
        otpTimeLeft--;
        const minutes = Math.floor(otpTimeLeft / 60);
        const seconds = otpTimeLeft % 60;
        timerEl.textContent = `Code expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (otpTimeLeft <= 0) {
          clearInterval(otpTimer);
          timerEl.textContent = 'Code expired. Please request a new one.';
          document.getElementById('verifyOTPBtn').disabled = true;
        }
      }, 1000);
    }

    function showOTPError(message) {
      const errorEl = document.getElementById('otpError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    // OTP Modal Event Listeners
    document.getElementById('verifyOTPBtn').addEventListener('click', async () => {
      const otp = document.getElementById('otpInput').value.trim();
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;
      
      // Validation
      if (!otp || otp.length !== 6) {
        showOTPError('Please enter a valid 6-digit code');
        return;
      }
      
      if (!newPassword || newPassword.length < 6) {
        showOTPError('Password must be at least 6 characters long');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showOTPError('Passwords do not match');
        return;
      }
      
      try {
        const btn = document.getElementById('verifyOTPBtn');
        btn.textContent = 'Verifying...';
        btn.disabled = true;
        
        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        const response = await fetch(`${backendUrl}/api/auth/verify-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: otpEmail,
            otp: otp,
            new_password: newPassword
          })
        });
        
        // Check if the response is successful (status 200-299)
        if (response.ok) {
          // Success - password was reset
          hideOTPModal();
          
          // Show success celebration modal
          showCelebration(
            'Password Reset Successful!', 
            'Your password has been changed successfully. You can now log in with your new password.', 
            '✅'
          );
          
          // Auto-close celebration and clear form after 3 seconds (no redirect for password reset)
          setTimeout(() => {
            closeCelebrationNoRedirect();
            // Clear the email input and reset form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            
            // CRITICAL: Sign out from Firebase to prevent conflicts
            if (auth && auth.currentUser) {
              auth.signOut().then(() => {
                console.log('Signed out from Firebase to prevent conflicts');
              }).catch((error) => {
                console.log('Firebase signout error (ignored):', error);
              });
            }
            
            // Clear any Firebase tokens
            localStorage.removeItem('firebase_token');
            localStorage.removeItem('firebase_user');
          }, 3000);
          
          return; // Exit successfully
        }
        
        // If we get here, there was an error
        const data = await response.json();
        throw new Error(data.detail || 'Failed to reset password');
        
      } catch (err) {
        showOTPError(err.message || 'Failed to reset password');
      } finally {
        const btn = document.getElementById('verifyOTPBtn');
        btn.textContent = 'Reset Password';
        btn.disabled = false;
      }
    });

    document.getElementById('resendOTPBtn').addEventListener('click', async () => {
      try {
        const btn = document.getElementById('resendOTPBtn');
        btn.textContent = 'Sending...';
        btn.disabled = true;
        
        const backendUrl = window.APP_CONFIG?.BACKEND_URL || `${window.location.protocol}//${window.location.hostname}:8000`;
        const response = await fetch(`${backendUrl}/api/auth/resend-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: otpEmail })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || 'Failed to resend code');
        }
        
        // Update message if dev OTP is provided
        const messageEl = document.getElementById('otpMessage');
        let message = `We've sent a new 6-digit code to ${otpEmail}. Enter it below to reset your password.`;
        if (data.otp) {
          message += ` (Development mode: ${data.otp})`;
        }
        messageEl.textContent = message;
        
        // Restart timer
        startOTPTimer();
        document.getElementById('verifyOTPBtn').disabled = false;
        
        // Clear OTP input
        document.getElementById('otpInput').value = '';
        
      } catch (err) {
        showOTPError(err.message || 'Failed to resend code');
      } finally {
        const btn = document.getElementById('resendOTPBtn');
        btn.textContent = 'Resend Code';
        btn.disabled = false;
      }
    });

    document.getElementById('cancelOTPBtn').addEventListener('click', () => {
      hideOTPModal();
    });

    // Auto-format OTP input
    document.getElementById('otpInput').addEventListener('input', (e) => {
      // Only allow digits
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    // Add Google button event listeners
    googleBtn.addEventListener('click', googleSignIn);
    googleBtnSignup.addEventListener('click', googleSignIn);

    // Remove auto-login behavior - users must manually sign in each time
  </script>
</body>

</html>